# 头寸规划模块需求文档

## 一、模块概述

头寸规划管理模块，用于管理银行间入款未交收数据、头寸意向、回购策略等功能。

## 二、开发阶段

### 阶段1：布局组件开发

#### 1.1 主布局组件（`views/position-planning/Layout.vue`）
- **左侧导航栏**（深蓝色背景）
  - 固收投资管理系统
  - 头寸规划（当前选中状态）
  - 其他菜单项
- **顶部导航栏**
  - 左侧：台账管理、Logo、搜索框
  - 右侧：MOF、在线刷新、用户信息、通知图标
- **主内容区域容器**

#### 1.2 顶部筛选区域组件（`views/position-planning/FilterSection.vue`）
- **筛选条件**
  - 产品组下拉框 可点击管理按钮进行管理
  - 投资经理下拉框：支持多选，如果选了"全部"，要取消其他选中项，如果选了除"全部"以外的其他项，要取消选中"全部"
  - 查询状态复选框（意向已下达/未下达）
- **操作按钮**
  - 查询按钮：用户点击查询按钮的时候，以下筛选条件要置空：回购策略、策略下拉框、隐藏T+1头寸、隐藏无业务类别
  - 清空按钮
  - 保存查询条件按钮
- **回购策略配置区域**
  - 策略类型单选按钮（隔夜/7D/14D）
  策略类型字典数据如下
  ```js 
   [
    {itemId:'GY',itemName:'隔夜'},
    {itemId:'7D',itemName:'7D'},
    {itemId:'14D',itemName:'14D'}
  ]
  ```
  - 策略下拉框
  - 策略配置按钮支持多选
  - 策略优先级单选（产品限制优先/当日策略优先）
- **核心操作按钮**
  - 试算意向按钮
  - 下达意向按钮
  - 风控试算按钮
- **显示选项**
  - 隐藏T+1头寸复选框
  - 隐藏无业务类别复选框
  - 自定义布局复选框

### 阶段2：数据表格组件开发

#### 2.1 银行间入款未交收表格（`views/position-planning/InterbankTable.vue`）
- **表格列**
  - 复选框列
  - 基金代码、基金简称
  - 正回购到期
  - 银行间当日入款（当日逆回购到期、当日T0买卖、昨日+1卖券/正回购首期、当日债券兑息兑付）
  - 一级缴款、二级买卖、基金申赎、净申赎
  - 定存到期、风险备付金、其它
  - T+0头寸（日初、测算、头寸核查表）
  - T+1头寸（日初、测算、头寸核查表）
  - 回购限制：当回购限制没有数据时，显示编辑icon按钮（蓝色 el-icon-edit，靠右对齐），支持用户点击编辑；有数据时显示蓝色可点击文字
  - 头寸意向（组合名称、隔夜(亿)、7D(亿)、14D(亿)、自定义天数列）
    - 组合名称列：当组合名称没有数据时，显示编辑icon按钮（蓝色 el-icon-edit，靠右对齐），支持用户点击编辑；有数据时显示蓝色可点击文字
    - **头寸意向列背景色标记**：针对表格列隔夜(亿)、7D(亿)、14D(亿)以及用户自定义列（最多五列），根据对应的状态值字段（overOpinionsState、opinions7dState、opinions14dState、opinionsCd1State、opinionsCd2State、opinionsCd3State、opinionsCd4State、opinionsCd5State）对单元格进行加背景色
      - 状态码0（无）：不需要标记颜色
      - 状态码1（已下达意向）：标记单元格背景色为绿色 #81DA54
      - 状态码2（下达意向后被修改）：标记单元格背景色为红色 #FF7C80
  - 进度查询（未成交意向、询价进度、前台进度、后台进度）- 其中"未成交意向"作为"进度查询"的二级表头展示
  - 加权成本（正回购、逆回购）
- **功能**
  - 复选框选择功能
  - 固定表格列：复选框、基金代码、基金简称
  - 数据展示
  - 分页功能（不需要）
  - 点击表格数据弹框查询明细，涉及表格列：正回购到期、当日逆回购到期、当日T0买卖、昨日+1卖券/正回购首期、当日债券兑息兑付、一级缴款、二级买卖、基金申赎、净申赎、定存到期、风险备付金、其它；这些列数据可点击，设置蓝色；弹框标题是动态的，不是固定展示"二级买卖"，要根据表头名字来动态展示
  - 明细弹框汇总显示：弹框上方显示汇总输入框，默认显示点击的表格数值（即该单元格的值），用户可修改汇总值并保存
  - T+0头寸和T+1头寸的二级列"测算"点击明细功能：
    - T+0头寸的"测算"列和T+1头寸的"测算"列数据可点击，设置蓝色
    - 点击后弹出明细弹框，显示明细数据（同正回购到期列的明细展示方式）
    - 弹框标题根据点击的列名动态显示（如："T+0头寸测算明细"、"T+1头寸测算明细"）
    - **注意：此明细弹框不支持修改汇总，只支持查看明细数据，不显示汇总输入框和保存按钮**
 
  - 进度查询列点击查看明细（未成交意向、询价进度、前台进度、后台进度）：
    - 接口：**POST** `/prodPositionDetails/query`（参考 @position-planning-api.md 第3节）
    - 接口参数：
      - `positionCode`：头寸代码（根据点击的列传对应的字段代码）
        - 未成交意向：`untradedIntentAmount`
        - 询价进度：`inquiryProgress`
        - 前台进度：`frontProgress`
        - 后台进度：`backProgress`
      - `fundCode`：产品代码
    - 明细表格列：
      - **点击"未成交意向"时显示的列**：
        - 证券代码（securityCode）
        - 证券名称（securityName）
        - 业务类别（businTypeName）
        - 交易金额(元)（occurBal，需格式化千分符）
        - 价格（price）
        - **注意**：不显示产品代码、头寸代码、是否交收、成交状态详情列
      - **点击"询价进度、前台进度、后台进度"时显示的列**：
        - 证券代码（securityCode）
        - 证券名称（securityName）
        - 业务类别（businTypeName）
        - 交易金额(元)（occurBal，需格式化千分符）
        - 价格（price）
        - 成交状态详情（dealstateText，动态列名：点击"询价进度"显示"询价成交状态详情"，点击"前台进度"显示"前台成交状态详情"，点击"后台进度"显示"后台成交状态详情"）
        - **注意**：不显示产品代码、头寸代码、是否交收列
    - 弹框标题：根据点击的列名动态显示（如："未成交意向明细"、"询价进度明细"、"前台进度明细"、"后台进度明细"）
    - 汇总金额：显示在表格上方，对交易金额进行求和并格式化千分符
  - 回购限制编辑功能：
    - 有数据时：显示回购限制内容（蓝色文字，可点击编辑）
    - 无数据时：显示编辑icon（蓝色 el-icon-edit，靠右对齐，可点击添加）
    - 点击后打开回购限制编辑弹框

#### 2.2 头寸意向表格（`views/position-planning/PositionIntentionTable.vue`）
- **说明**：此组件已合并到主表格中，作为"头寸意向"列组展示
- **保留原因**：如需单独展示头寸意向数据时可使用此组件
- **新增列功能** 
- 表头单元格"头寸意向"的右侧有一个icon图标（可使用elementUI-icon图标库中的el-icon-circle-plus-outline），
点击图标，可新增表格列，用户直接可填写表头和表格数据，表头名称是用户自己输入，最多可新增五列，用户填写的表头和值都要传给后台，接口中已有对应参数。填写完表格单元格数据就要请求接口传给后台
- 点击新增按钮时直接在【头寸意向】的二级表头后面新增一列，不需要弹框输入表头，新增表头不发送后台，等用户设置每行基金产品的值的时候将标题和值提交给后台
- 表格数据支持传空值给后端，不要处理成0
- 如果表格没有查询出数据，要限制头寸意向不能新增自定义列
- 新增列：点击加号，创建空表头的自定义列，填写表头：用户在表头输入框填写文字，只更新本地状态（v-model），不发送后台，当用户填写好数据保存后台后，新增的表头不允许修改
- **编辑组合名称**
  - 有数据时：显示组合名称（蓝色文字，可点击编辑）
  - 无数据时：显示编辑icon（蓝色 el-icon-edit，靠右对齐，可点击添加）
  - 点击后打开组合名称编辑弹框
- **组合名称编辑弹框**
  - 产品名称（不可编辑，仅展示）
  - 组合名称下拉框（可修改）
  - 组合下拉框数据接口：@common.md【3. 根据产品查询组合】
  - 取消、保存按钮
- **保存接口**
  - 接口：@position-planning-api.md【2.更新组合持仓产品字段值】`prodPosition/updateFieldValue`
  - 参数说明：
    - `fundCode`：产品代码（必传）
    - `fieldCode`：字段代码，固定传 `'combiId'`
    - `fieldValue`：选中的组合ID
- 保存成功后要刷新主表格数据
- **编辑头寸意向数据**
- 头寸意向的隔夜、7D、14D三列数据支持用户直接编辑
- 用户在输入框中修改数值后，失去焦点时自动发送后台保存
- 接口调用@position-planning-api.md【2.更新组合持仓产品字段值】`prodPosition/updateFieldValue`
- 参数说明：
  - `fundCode`：产品代码（必传）
  - `fieldCode`：修改的字段名（隔夜：overOpinions，7D：opinions7d，14D：opinions14d）
  - `fieldValue`：修改的数值
- 保存成功后需刷新整个表格
- **注意**：刷新表格数据时，需要保留用户已勾选的产品选项，不要清除已勾选状态
- **头寸意向列背景色标记**：
  - 针对表格列隔夜(亿)、7D(亿)、14D(亿)以及用户自定义列（最多五列），根据对应的状态值字段（overOpinionsState、opinions7dState、opinions14dState、opinionsCd1State、opinionsCd2State、opinionsCd3State、opinionsCd4State、opinionsCd5State）对单元格进行加背景色
  - 状态码说明：
    - 0（无）：不需要标记颜色
    - 1（已下达意向）：标记单元格背景色为绿色 #81DA54
    - 2（下达意向后被修改）：标记单元格背景色为红色 #FF7C80

### 阶段3：配置面板组件开发

#### 3.1 策略配置面板（`views/position-planning/StrategyConfigPanel.vue`）
- 策略名字输入框
- 产品名称下拉框：接口采用同主界面-查询条件：产品组的下拉数据的接口
- 预留现金(万)输入框
- 产品号下拉框
- 隔夜比例(%)输入框
- 7D (%)输入框
- 14D (%)输入框
- 是否默认使用单选（是/否）
- 取消、保存按钮

#### 3.2 查询表格数据明细面板（正回购到期、当日逆回购到期、当日T0买卖、昨日+1卖券/正回购首期、当日债券兑息兑付、一级缴款、二级买卖、基金申赎、净申赎、定存到期、风险备付金、其它）（`views/position-planning/SecondaryTradePanel.vue`）
- **汇总输入框**：显示点击的表格数值（即该单元格的值），用户可修改汇总值并保存
  - **注意**：当有新增的行数据时，汇总输入框不可修改（禁用状态）
- **明细表格**（证券代码、证券名称、业务类别、交易金额、是否交收）
  - **后端请求查询的详情数据不能修改**：从接口查询返回的明细数据为只读，不支持编辑
  - 表格下方添加"新增"按钮（采用icon图标，elementUI按钮类型为plain）
  - 点击"新增"按钮可以新增一行可编辑的数据
  - **新增的行数据**：可以编辑，操作列只显示删除按钮
  - **新增行数据字段要求**：
    - 证券名称：下拉框，支持远程搜索，接口：@position-planning-api.md【10. 搜索证券信息】`/stockInfo/searchStock`，参数：`securityName`（证券名称/代码）
    - 证券代码：当用户选择了证券名称后，自动填充证券代码，不可编辑，仅用于展示
    - 业务类别：下拉框，接口：@position-planning-api.md【11. 查询投研头寸明细业务类别】`/position/queryBusinType`，参数：`positionCode`（点击的字段名，即头寸代码），返回字段：`businType`（业务类别）、`businTypeName`（业务类别名称），保存时需将这两个字段对接到保存接口参数中
      - **注意**：每次点击新增行时，需要根据当前点击的字段名（positionCode）重新请求业务类别接口，确保业务类别选项与当前字段匹配
    - 交易金额：可编辑输入框，限制只能输入数字（支持负数）
    - 价格：可编辑输入框，限制只能输入数字
    - 是否交收：下拉框，选项（1：否，2：是）
- 取消、保存按钮
- **保存接口**：`prodPosition/updateFieldValue`（参考 @position-planning-api.md 第2节）
- **保存参数说明**：
  - 如果修改了汇总值（无新增行数据）：传参 `fundCode`、`fieldCode`、`fieldValue`
  - 如果有新增或修改行数据：传参 `fundCode`、`fieldCode`、`details`（明细集合数组）
    - `details` 数组元素包含：`positionCode`（头寸代码）、`securityCode`（证券代码）、`securityName`（证券名称）、`businType`（业务类别）、`businTypeName`（业务类别名称）、`occurBal`（交易金额）、`price`（价格）
- 保存成功后需刷新整个表格

#### 3.3 回购限制面板（`views/position-planning/RepurchaseRestrictionPanel.vue`）
- 期限限制下拉框
回购期限类型字典数据如下：
```js
  [
    {itemId:'GY',itemName:'只能隔夜'},
    {itemId:'7D',itemName:'只能7天'},
    {itemId:'14D',itemName:'只能14天'}
  ]
```
- 正回购质押券限制下拉框（单选）
  - 接口：字典数据接口（参考 @common.md）
  - 参数：`dictId: "HG_SECURITY_TYPE_CONFIG"`
  - 下拉框配置：单选、可搜索、可清空
- 逆回购质押券限制下拉框（单选）
  - 接口：字典数据接口（参考 @common.md）
  - 参数：`dictId: "HG_DOWN_PLEDGE_BOND_TYPE"`
  - 下拉框配置：单选、可搜索、可清空
- 取消、保存按钮
- **保存接口参数说明**
  - 接口：`/prodPosition/updateFieldValue`（参考 @position-planning-api.md 第2节）
  - 需要分三次调用接口保存三个字段：
    1. 保存期限限制：
       - `fundCode`: 产品代码（必传）
       - `fieldCode`: `'repurchaseRestrictionType'` // 期限限制字段
       - `fieldValue`: 选中的期限限制值（如：'GY'、'7D'、'14D'）
    2. 保存正回购质押券限制：
       - `fundCode`: 产品代码（必传）
       - `fieldCode`: `'pledgeRepoLimit'` // 正回购质押券限制字段
       - `fieldValue`: 选中的正回购质押券限制值
    3. 保存逆回购质押券限制：
       - `fundCode`: 产品代码（必传）
       - `fieldCode`: `'reverseRepoLimit'` // 逆回购质押券限制字段
       - `fieldValue`: 选中的逆回购质押券限制值

### 阶段4：核心功能实现

#### 4.1 创建意向预览弹窗组件（`views/position-planning/IntentionPreviewDialog.vue`）
- 预览生成的回购意向
- 支持风控试算功能
- 支持意向下达功能
- 显示冲突提示信息

#### 4.2 查询功能
- **默认不查询数据**：
  - 默认进入界面时不查询数据，表格为空状态
  - 等用户选择了产品组并点击查询按钮后，才调用后台接口查询数据
- 筛选条件组合查询
- **产品组必选验证**：
  - 点击查询按钮时，产品组是必选的
  - 如果没有选择产品组，提示用户："请先选择产品组"，并阻止查询操作
- **产品组传参逻辑**：
  - 点击查询按钮时，产品组的传参要根据下拉选择的数据情况来提取产品代码
  - 如果选择的是组（即下拉数据的detail数组长度大于0），要取detail数组里面的ocode，而不是取rid
  - 如果detail数组为空，可以直接取rid
- 查询结果展示
- 清空功能
- 保存查询条件（本地存储）

#### 4.3 试算意向功能
- 选择表格的一条数据，点击试算意向按钮，请求接口

#### 4.4 意向下达功能
- 根据表格字段是否下达，当勾选的数据是已下达的时候，按钮禁用，且勾选数据只能一条，大于1条时按钮也要禁用
- 点击按钮：意向下达，请求后端接口
- 成功提示
**后端返回逻辑处理:**
- 假设后端返回的code==2 请用弹框提示用户：弹框标题：提示，显示内容为后端接口返回的字段message内容，按钮为取消和继续
- 如果用户点击【继续】将入参ignoreAmtCheck=1，请求原来的接口
- 假设code==6002 请用弹框提示用户：弹框标题：提示，显示内容为后端接口返回的字段message内容，按钮为取消和继续
点击【继续】将入参concentrateDuek=1，请求原来的接口

#### 4.5 风控试算功能
- TODO

#### 4.6 明细弹窗功能
- 点击表格数据（涉及列：正回购到期、当日逆回购到期、当日T0买卖、昨日+1卖券/正回购首期、当日债券兑息兑付、一级缴款、二级买卖、基金申赎、净申赎、定存到期、风险备付金、其它），弹框显示明细
- 弹框上方显示汇总输入框，默认显示点击的表格数值（即该单元格的值）
- 明细数据展示：显示该字段对应的明细列表
- **明细表格行数据编辑功能**：
  - **后端请求查询的详情数据不能修改**：从接口查询返回的明细数据为只读，不支持编辑
  - 表格下方添加"新增"按钮（采用icon图标，elementUI按钮类型为plain），点击可新增一行可编辑数据
  - **新增的行数据**：可以编辑，操作列只显示删除按钮
  - 当有新增的行数据时，汇总输入框不可修改（禁用状态）
  - **新增行数据字段要求**：
    - 证券名称：下拉框，支持远程搜索，接口：@position-planning-api.md【10. 搜索证券信息】
    - 证券代码：选择证券名称后自动填充，不可编辑
    - 业务类别：下拉框，接口：@position-planning-api.md【11. 查询投研头寸明细业务类别】`/position/queryBusinType`，参数：`positionCode`（点击的字段名，即头寸代码），返回字段：`businType`（业务类别）、`businTypeName`（业务类别名称），保存时需将这两个字段对接到保存接口参数中
      - **注意**：每次点击新增行时，需要根据当前点击的字段名（positionCode）重新请求业务类别接口，确保业务类别选项与当前字段匹配
    - 交易金额：可编辑输入框，限制只能输入数字（支持负数）
    - 价格：可编辑输入框，限制只能输入数字
    - 是否交收：下拉框，选项（1：否，2：是）
- **保存逻辑**：
  - 如果只修改了汇总值（无新增/修改行数据）：传参 `fundCode`、`fieldCode`、`fieldValue`
  - 如果有新增或修改行数据：传参 `fundCode`、`fieldCode`、`details`（明细集合数组）
- 保存后刷新整个表格
- **T+0头寸和T+1头寸的"测算"列明细弹窗**：
  - 点击T+0头寸的"测算"列或T+1头寸的"测算"列，弹框显示明细
  - 明细数据展示：显示该字段对应的明细列表（同正回购到期列的明细展示方式）
  - **不支持修改汇总**：此明细弹框只支持查看，不显示汇总输入框和保存按钮，仅显示明细表格和取消按钮

## 三、关键功能点说明

### 3.1 试算意向功能详细说明
根据图片中的黄色标注说明：
- 点击【试算意向】按钮，根据头寸情况以及回购策略生成相关的回购意向询价并弹窗预览
- 预览页面支持风控试算和意向下达
- 意向下达到交易部的"新的回购询价意向"菜单
- 需要校验生成的意向和回购限制是否相悖
- 如果相悖了则给出提示，并且相悖的限制条件不要带给交易模块，其他限制还是要带
- 默认勾选，产品限制优先

### 3.2 明细弹窗功能说明
- 金额/笔数点击弹窗显示明细
- 需要展示详细的交易明细信息
